name: 正在打包2个镜像内容一样,7个应用

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出你自己的代码（为了拿到你修改过的 Containerfile）
      - name: Checkout Your Code
        uses: actions/checkout@v4

      # 2. 【核心修改】动态拉取官方最新的构建环境文件
      # 这一步会自动获取官方最新的 resources 脚本，你不需要在仓库里手动维护它们
      - name: Fetch Latest Official Environment
        run: |
          echo "正在从官方仓库拉取最新的构建资源..."
          git clone --depth 1 https://github.com/frappe/frappe_docker.git official_repo
          # 将构建必须的资源拷贝到当前目录，以便 Docker 构建时使用
          cp -r official_repo/resources .
          cp official_repo/install_x11_deps.sh .
          # 清理临时文件夹
          rm -rf official_repo
          echo "资源拉取完成。"

      # 3. 安装 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4. 登录 Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 5. 构建并推送镜像
      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: .
          # 使用你仓库里 images/layered/Containerfile 路径下的图纸
          file: images/layered/Containerfile
          push: true
          # 同时给镜像打上两个标签
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/15-neizhang:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/15-waizhang:latest
          # 传入构建参数
          build-args: |
            FRAPPE_PATH=https://github.com/frappe/frappe
            FRAPPE_BRANCH=version-15
            APPS_JSON_BASE64=${{ secrets.APPS_JSON_BASE64 }}
