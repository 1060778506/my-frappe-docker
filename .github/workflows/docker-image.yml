# 基础镜像使用官方版本
ARG FRAPPE_BRANCH=version-15
FROM frappe/erpnext:${FRAPPE_BRANCH}

# 1. 切换到 root 用户进行系统级安装
USER root

# ### 修改点 A: 预装 Chromium 引擎，解决 print_designer 下载慢的问题
RUN apt-get update && apt-get install -y \
    chromium \
    chromium-common \
    chromium-sandbox \
    libgbm1 \
    sed \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ### 修改点 B: 设置环境变量，强行指定浏览器路径
ENV CLIENT_CHROME_PATH=/usr/bin/chromium
# 顺便设置一个环境变量，解决有些库对中文显示的支持
ENV QT_QPA_PLATFORM=offscreen

# 2. 切换回 frappe 用户安装应用
USER frappe

# 这里假设你通过 build-args 传入了 APPS_JSON_BASE64
ARG APPS_JSON_BASE64
RUN if [ -n "${APPS_JSON_BASE64}" ]; then \
    echo "${APPS_JSON_BASE64}" | base64 -d > /home/frappe/frappe-bench/sites/apps.json; \
    fi

# 执行标准的安装流程 (这里会安装 insights, print_designer 等)
# 注意：这一步会根据你的 apps.json 下载代码
RUN bench get-app --allow-fetch-base64

# ### 修改点 C: 自动化修复 SSL 验证问题 (镜像内手术)
# 在打包阶段就直接把那几个 py 文件的 True 改成 False
RUN sed -i 's/ssl_verify_cert=True/ssl_verify_cert=False/g' /home/frappe/frappe-bench/apps/insights/insights/insights/doctype/insights_data_source/sources/frappe_db.py && \
    sed -i 's/ssl_verify_cert=bool(not frappe.conf.developer_mode)/ssl_verify_cert=False/g' /home/frappe/frappe-bench/apps/insights/insights/insights/doctype/insights_data_source/sources/frappe_db.py && \
    sed -i 's/ssl_verify_cert=use_ssl/ssl_verify_cert=False/g' /home/frappe/frappe-bench/apps/insights/insights/insights/doctype/insights_data_source/sources/mariadb.py

# 最后完成构建逻辑
