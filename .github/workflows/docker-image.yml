name: 生产环境-自动化精准补丁版-Insights-SSL修复

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 拉取本仓库代码
        uses: actions/checkout@v4

      - name: 2. 获取官方图纸并注入手术补丁
        run: |
          git clone --depth 1 https://github.com/frappe/frappe_docker.git official_repo
          cp -r official_repo/resources .
          cp official_repo/install_x11_deps.sh .
          
          # 直接用 printf 把补丁追加到官方图纸末尾，这种方式对 YAML 最友好，禁用SSL
          printf "\nUSER root\nRUN if [ -d \"/home/frappe/frappe-bench/apps/insights\" ]; then \\" >> official_repo/images/layered/Containerfile
          # 搜索并修改 frappe_db.py (不管它在哪个深度)
          printf "\n    find /home/frappe/frappe-bench/apps/insights -name \"frappe_db.py\" | xargs -r sed -i 's/ssl_verify_cert=True/ssl_verify_cert=False/g'; \\" >> official_repo/images/layered/Containerfile
          printf "\n    find /home/frappe/frappe-bench/apps/insights -name \"frappe_db.py\" | xargs -r sed -i 's/ssl_verify_cert=bool(not frappe.conf.developer_mode)/ssl_verify_cert=False/g'; \\" >> official_repo/images/layered/Containerfile
          # 搜索并修改 mariadb.py
          printf "\n    find /home/frappe/frappe-bench/apps/insights -name \"mariadb.py\" | xargs -r sed -i 's/ssl_verify_cert=use_ssl/ssl_verify_cert=False/g'; \\" >> official_repo/images/layered/Containerfile
          printf "\nfi\nUSER frappe\n" >> official_repo/images/layered/Containerfile


      - name: 3. 解析应用清单 (apps.json)
        id: get_apps
        run: |
          APPS_CONTENT=$(cat apps.json | jq -c .)
          echo "APPS_BASE64=$(echo -n $APPS_CONTENT | base64 -w 0)" >> $GITHUB_OUTPUT

      - name: 4. 设置 Docker Buildx 构建引擎
        uses: docker/setup-buildx-action@v3

      - name: 5. 登录 Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

# 第六步：开始构建镜像并推送（包含内账和外账两个标签）
      - name: 6. 开始构建镜像并推送
        uses: docker/build-push-action@v5
        with:
          context: .
          # 使用我们刚才“手术改造”过的官方图纸
          file: official_repo/images/layered/Containerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/15-neizhang:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/15-waizhang:latest
          build-args: |
            FRAPPE_PATH=https://github.com/frappe/frappe
            FRAPPE_BRANCH=version-15
            APPS_JSON_BASE64=${{ steps.get_apps.outputs.APPS_BASE64 }}
